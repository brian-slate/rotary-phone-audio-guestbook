<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='img/favicon.ico') }}" />
  <title>{% block title %}BLACK BOX{% endblock %}</title>
  <!-- CRITICAL: Apply dark mode class BEFORE any content renders to prevent flash -->
  <script>
    // Immediately apply dark class if needed (before any CSS loads)
    (function() {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'dark' || (!savedTheme && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark');
      }
    })();
  </script>
  <link href="{{ url_for('static', filename='css/output.min.css') }}" rel="stylesheet" />
  <link href="{{ url_for('static', filename='css/custom.css') }}" rel="stylesheet" />
  <!-- Load theme.js to handle toggle interactions -->
  <script src="{{ url_for('static', filename='js/theme.js') }}" defer></script>
  <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
  {% block extra_head %}{% endblock %}
</head>

<body class="bg-background text-text dark:bg-dark-background dark:text-dark-text transition-colors duration-300">
  <header class="bg-yellow-400 dark:bg-dark-background border-b-4 border-black dark:border-yellow-400">
    <div class="container mx-auto px-4 py-4">
      <!-- Title Bar -->
      <div class="border-4 border-black dark:border-yellow-400 bg-yellow-400 dark:bg-black mb-3 shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] dark:shadow-[4px_4px_0px_0px_rgba(252,211,77,1)]">
        <a href="{{ url_for('index') }}" class="text-2xl md:text-3xl font-black flex items-center justify-center py-3 text-black dark:text-yellow-400 uppercase tracking-widest">
          <i class="fas fa-phone-alt mr-3 transform -rotate-45"></i>
          BLACK BOX
        </a>
      </div>
      
      <!-- Checkerboard divider -->
      <div class="checkerboard-divider text-black dark:text-yellow-400 mb-3"></div>
      
      <div class="flex justify-between items-center">
        <!-- Spacer -->
        <div class="flex-1"></div>
        
        <!-- Center: Navigation Buttons -->
        <div class="flex items-center gap-3">
          <a href="{{ url_for('index') }}"
            class="bg-black dark:bg-yellow-400 text-yellow-400 dark:text-black border-2 border-black dark:border-yellow-400 px-4 py-2 font-bold uppercase tracking-wider hover:bg-gray-800 dark:hover:bg-yellow-500 transition-colors flex items-center gap-2">
            <i class="fas fa-microphone"></i>
            <span class="hidden sm:inline">Recordings</span>
          </a>

          <a href="{{ url_for('edit_config') }}"
            class="bg-black dark:bg-yellow-400 text-yellow-400 dark:text-black border-2 border-black dark:border-yellow-400 px-4 py-2 font-bold uppercase tracking-wider hover:bg-gray-800 dark:hover:bg-yellow-500 transition-colors flex items-center gap-2">
            <i class="fas fa-cog"></i>
            <span class="hidden sm:inline">Config</span>
          </a>
        </div>

        <!-- Right: Theme Switcher and Logout -->
        <div class="flex-1 flex justify-end items-center gap-3">
          <label class="theme-switch cursor-pointer bg-gray-200 dark:bg-gray-800 text-gray-800 dark:text-yellow-400 border-2 border-gray-300 dark:border-gray-700 px-3 py-2 font-bold uppercase tracking-wider hover:bg-gray-300 dark:hover:bg-gray-700 transition-all flex items-center gap-2">
            <input type="checkbox" class="hidden" aria-label="Toggle dark mode">
            <div class="flex items-center gap-2">
              <i id="theme-icon-fa" class="fas fa-sun transition-transform duration-300"></i>
              <span class="text-xs" id="theme-label">Dark</span>
            </div>
          </label>
          {% if password_protected and session.get('authenticated') %}
          <a href="{{ url_for('logout') }}"
            class="bg-red-500 hover:bg-red-600 text-white border-2 border-red-600 px-3 py-2 font-bold uppercase tracking-wider transition-colors flex items-center gap-2">
            <i class="fas fa-sign-out-alt"></i>
            <span class="hidden sm:inline text-xs">Logout</span>
          </a>
          {% endif %}
        </div>
      </div>
      </div>
    </div>
  </header>
  <main class="container mx-auto px-4 py-8">
    {% if ai_processing_error %}
      <div class="mb-6 p-4 border-l-4 border-red-600 bg-red-50 text-red-800 dark:bg-red-900/30 dark:text-red-200 rounded" role="alert">
        <div class="flex items-start">
          <i class="fas fa-exclamation-triangle mr-3 mt-1"></i>
          <div>
            <p class="font-semibold">AI processing error</p>
            <p class="text-sm">{{ ai_processing_error.message }}</p>
            {% if ai_processing_error.timestamp %}
              <p class="text-xs opacity-75 mt-1">Last error at {{ ai_processing_error.timestamp }}</p>
            {% endif %}
            <p class="text-xs mt-2">AI is still enabled. You can disable it or update your API key in <a href="{{ url_for('edit_config') }}" class="underline">Settings</a>.</p>
          </div>
        </div>
      </div>
    {% endif %}
    {% block content %}{% endblock %}
  </main>

  <footer class="text-center py-4 text-xs text-gray-500 dark:text-gray-400">
    <p>BLACK BOX v{{ version }}</p>
  </footer>

  <script src="{{ url_for('static', filename='js/menu.js') }}"></script>
  {% block extra_js %}{% endblock %}
</body>

<div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
  <div class="bg-white dark:bg-dark-secondary rounded-lg shadow-xl max-w-md w-full mx-4 p-6">
    <h3 id="modal-title" class="text-lg font-bold mb-4">Confirm Action</h3>
    <p id="modal-message" class="mb-6">Are you sure you want to proceed?</p>
    <div class="flex justify-end space-x-3">
      <button id="modal-cancel"
        class="px-4 py-2 border rounded hover:bg-gray-100 dark:hover:bg-gray-700">Cancel</button>
      <button id="modal-confirm" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">Confirm</button>
    </div>
  </div>
</div>

<script>
  // Custom confirm dialog
  function showConfirmDialog(title, message, onConfirm) {
    const modal = document.getElementById('confirmation-modal');
    document.getElementById('modal-title').textContent = title;
    document.getElementById('modal-message').textContent = message;

    const confirmBtn = document.getElementById('modal-confirm');
    const cancelBtn = document.getElementById('modal-cancel');

    modal.classList.remove('hidden');

    // Clear previous event listeners
    const newConfirmBtn = confirmBtn.cloneNode(true);
    const newCancelBtn = cancelBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

    newConfirmBtn.addEventListener('click', () => {
      modal.classList.add('hidden');
      onConfirm();
    });

    newCancelBtn.addEventListener('click', () => {
      modal.classList.add('hidden');
    });
  }
</script>

<div id="toast" class="fixed bottom-16 left-4 transform transition-opacity transition-transform duration-300 opacity-0 hidden">
  <div class="flex items-center px-4 py-3 rounded-lg shadow-lg max-w-md">
    <div id="toast-icon" class="mr-3"></div>
    <div id="toast-message"></div>
  </div>
</div>

<script>
  function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toast-message');
    const toastIcon = document.getElementById('toast-icon');

    toastMessage.textContent = message;

    // Set type-specific styles
    if (type === 'success') {
      toast.className = 'fixed bottom-16 left-4 transform transition-transform duration-300 bg-green-100 dark:bg-green-800 text-green-800 dark:text-green-100 rounded-lg shadow-lg px-4 py-3';
      toastIcon.innerHTML = '<i class="fas fa-check-circle"></i>';
    } else if (type === 'error') {
      toast.className = 'fixed bottom-16 left-4 transform transition-transform duration-300 bg-red-100 dark:bg-red-800 text-red-800 dark:text-red-100 rounded-lg shadow-lg px-4 py-3';
      toastIcon.innerHTML = '<i class="fas fa-exclamation-circle"></i>';
    }

    // Make toast visible immediately without the transform
    toast.style.transform = 'translateY(0)';
    toast.style.opacity = '1';
    toast.style.display = 'block';

    // Hide after 3 seconds
    setTimeout(() => {
      toast.style.opacity = '0';
      setTimeout(() => {
        toast.style.display = 'none';
      }, 300); // Wait for fade out transition
    }, 3000);
  }
</script>

<div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
  <div class="bg-white dark:bg-dark-secondary p-6 rounded-lg shadow-xl flex items-center">
    <svg class="animate-spin h-8 w-8 mr-3 text-accent" xmlns="http://www.w3.org/2000/svg" fill="none"
      viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor"
        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
      </path>
    </svg>
    <span id="loading-text">Processing...</span>
  </div>
</div>

<script>
  function showLoading(message = 'Processing...') {
    document.getElementById('loading-text').textContent = message;
    document.getElementById('loading-overlay').classList.remove('hidden');
  }

  function hideLoading() {
    document.getElementById('loading-overlay').classList.add('hidden');
  }
</script>

<!-- Theme initialization fallback -->
<script>
  // Ensure theme is properly initialized even if theme.js has issues
  (function () {
    try {
      // Check if theme.js initialized properly - give it time to load first
      setTimeout(function () {
        if (window.themeManager) {
          console.log("Using themeManager API for theme");
          return; // Already initialized properly
        }

        console.log("Applying theme fallback initialization");

        // Fallback initialization
        const savedTheme = localStorage.getItem('theme');

        // Apply theme based on localStorage or system preference
        if (savedTheme === 'dark' ||
          (!savedTheme && window.matchMedia &&
            window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          document.documentElement.classList.add('dark');

          // Try to update icons
          const themeIcon = document.getElementById('theme-icon');
          const homeIcon = document.getElementById('home-icon');
          const settingsIcon = document.getElementById('settings-icon');
          const toggleSwitch = document.querySelector('.theme-switch input[type="checkbox"]');

          if (themeIcon) themeIcon.src = '/static/img/moon.png';
          if (homeIcon) homeIcon.src = '/static/img/home_dark.png';
          if (settingsIcon) settingsIcon.src = '/static/img/gear_dark.png';
          if (toggleSwitch) toggleSwitch.checked = true;
        } else {
          document.documentElement.classList.remove('dark');
        }

        // Initialize toggle event listener as fallback
        const toggleSwitch = document.querySelector('.theme-switch input[type="checkbox"]');
        if (toggleSwitch) {
          toggleSwitch.addEventListener('change', function (e) {
            if (e.target.checked) {
              document.documentElement.classList.add('dark');
              localStorage.setItem('theme', 'dark');

              const themeIcon = document.getElementById('theme-icon');
              const homeIcon = document.getElementById('home-icon');
              const settingsIcon = document.getElementById('settings-icon');

              if (themeIcon) themeIcon.src = '/static/img/moon.png';
              if (homeIcon) homeIcon.src = '/static/img/home_dark.png';
              if (settingsIcon) settingsIcon.src = '/static/img/gear_dark.png';
            } else {
              document.documentElement.classList.remove('dark');
              localStorage.setItem('theme', 'light');

              const themeIcon = document.getElementById('theme-icon');
              const homeIcon = document.getElementById('home-icon');
              const settingsIcon = document.getElementById('settings-icon');

              if (themeIcon) themeIcon.src = '/static/img/sun.png';
              if (homeIcon) homeIcon.src = '/static/img/home_light.png';
              if (settingsIcon) settingsIcon.src = '/static/img/gear_light.png';
            }
          });

          console.log("Fallback theme handler initialized");
        }
      }, 500); // Give theme.js 500ms to initialize
    } catch (error) {
      console.error("Theme initialization error:", error);
    }
  })();
</script>

</html>